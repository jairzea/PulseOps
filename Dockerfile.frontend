# Multi-stage build para optimizar tama침o de imagen

# =====================================
# Stage 1: Builder - Compilar aplicaci칩n
# =====================================
FROM node:20-alpine AS builder

WORKDIR /app

# Copiar package files
COPY package*.json ./
COPY tsconfig.json ./
COPY apps/frontend/package*.json ./apps/frontend/
COPY apps/frontend/tsconfig*.json ./apps/frontend/
COPY apps/frontend/vite.config.ts ./apps/frontend/
COPY apps/frontend/postcss.config.js ./apps/frontend/
COPY apps/frontend/tailwind.config.js ./apps/frontend/
COPY packages/shared-types/package*.json ./packages/shared-types/
COPY packages/shared-types/tsconfig.json ./packages/shared-types/
COPY packages/analysis-engine/package*.json ./packages/analysis-engine/
COPY packages/analysis-engine/tsconfig.json ./packages/analysis-engine/

# Instalar dependencias
RUN npm ci

# Copiar c칩digo fuente
COPY packages/shared-types/src ./packages/shared-types/src
COPY packages/analysis-engine/src ./packages/analysis-engine/src
COPY apps/frontend/src ./apps/frontend/src
COPY apps/frontend/index.html ./apps/frontend/
COPY apps/frontend/public ./apps/frontend/public

# Construir paquetes en orden
RUN npm run build --workspace=packages/shared-types
RUN npm run build --workspace=packages/analysis-engine
RUN npm run build --workspace=apps/frontend

# =====================================
# Stage 2: Production - Nginx
# =====================================
FROM nginx:alpine AS production

# Copiar configuraci칩n personalizada de nginx
COPY config/nginx.conf /etc/nginx/nginx.conf

# Copiar build desde stage anterior
COPY --from=builder /app/apps/frontend/dist /usr/share/nginx/html

# Crear usuario no-root para nginx
RUN chown -R nginx:nginx /usr/share/nginx/html && \
    chown -R nginx:nginx /var/cache/nginx && \
    chown -R nginx:nginx /var/log/nginx && \
    chown -R nginx:nginx /etc/nginx/conf.d && \
    touch /var/run/nginx.pid && \
    chown -R nginx:nginx /var/run/nginx.pid

# Cambiar a usuario no-root
USER nginx

# Exponer puerto
EXPOSE 80

# Health check
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
  CMD wget --quiet --tries=1 --spider http://localhost:80/ || exit 1

# Comando de inicio
CMD ["nginx", "-g", "daemon off;"]
